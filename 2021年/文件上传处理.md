# æ–‡ä»¶ä¸Šä¼ å¤„ç†

> é™åˆ¶åŒæ—¶ä¸Šä¼ æ–‡ä»¶æ•°é‡ï¼Œæ˜¯ä¸ºäº†æ›´å¥½çš„ä½“éªŒï¼Œè€Œä¸æ˜¯ä¸€ä¸‹å­ä¸Šä¼ 10ä¸ªï¼Œå…¨éƒ¨ä¸€èµ·è¯·æ±‚ã€‚
>
> åˆ†ç‰‡ä¸Šä¼ ï¼Œåœ¨å¤„ç†å¤§æ–‡ä»¶ä¸­ï¼Œæ˜¾å¾—ç‰¹åˆ«é‡è¦ï¼Œå› ä¸ºæœåŠ¡ä¸€ä¸‹å­æ¥å—è¿™ä¹ˆå¤§çš„æ–‡ä»¶è¯»å–éå¸¸è€—æ€§èƒ½ã€‚



#### é™åˆ¶åŒæ—¶ä¸Šä¼ æ•°é‡

æ€ä¹ˆé™åˆ¶ï¼Ÿæˆ‘çœ‹è¿‡ä¸€äº›ä¹¦ç±æ¨èçš„åŠæ³•å°±æ˜¯promiseï¼Œpromiseæ˜¯æœ€å¥½çš„è§£å†³æ–¹æ¡ˆã€‚

å…¶ä»–çš„ä¸€äº›æ–¹æ¡ˆï¼Œæ¯”å¦‚åŸç”ŸåŠ é”ï¼Œè¿­ä»£å™¨ï¼Œç­‰ç­‰ã€‚

```js
async getFileData(e) {
      this.loadingFlag = true // ä¸å…è®¸æäº¤
      let filesArray = [] // æ–‡ä»¶äºŒè¿›åˆ¶åˆ—è¡¨
      let viewFile = []  // é¡µé¢æ˜¾ç¤ºçš„æ•°æ®
      for (let i = 0; i < e.target.files.length; i++) {
        let obj = {
          percentage: 0,
        }
        for (const key in e.target.files[i]) {
          obj[key] = e.target.files[i][key]
        }
        obj.size = (obj.size / 1048576).toFixed(2) + ' MB'
        viewFile.push(obj)
        filesArray.push(e.target.files[i])
      }
      this.viewFile = [...this.viewFile, ...viewFile]
			// é‡ç‚¹æ˜¯è¿™é‡Œå¼€å§‹ä¸Šä¼ äº† 
      this.limitLoad(filesArray, this.uploadFile)
      e.target.value = '' // å½“å‚æ•°æ‹¿åˆ°åï¼Œæ¸…ç©ºe.target.value,å…å¾—æ•°æ®æ˜¾ç¤ºåœ¨é¡µé¢ä¸Šé¢ï¼Œå› ä¸ºvueæ£€æµ‹ä¸åˆ°æ‰€ä»¥ç»„ä»¶ä¸ä¼šæ›´æ–°çš„ï¼Œåªèƒ½è‡ªå·±å»å¤„ç†ï¼Œæœ‰v-ifï¼Œç­‰ç­‰å…¶ä»–åŠæ³•
},

 async limitLoad(files, handler, limit = 3) {
      const fileArray = files
      const that = this
      // åˆå§‹åŒ–,å¹¶å‘è¯·æ±‚åˆ°æœ€å¤§æ•°ï¼Œå¹¶å‘limité¡¹
      let promises = fileArray.splice(0, limit).map(async (item, index) => {
        // è¿™é‡Œè¿”å›çš„ index æ˜¯ä»»åŠ¡åœ¨ promises çš„ä¸‹æ ‡ï¼Œ
        // ç”¨äºåœ¨ Promise.race ä¹‹åæ‰¾åˆ°å®Œæˆçš„ä»»åŠ¡ä¸‹æ ‡
        // åå°éœ€è¦çš„æ–‡ä»¶åç¼€ï¼Œå®ƒä¼šè¿”å›æ¥ï¼Œæ–‡ä»¶idï¼Œnameã€‚
        let suffix = item.name.split('.').pop().toLowerCase()
        let res = await getUploadId({ suffix })
        // handler å°†æ­£åœ¨å¤„ç†çš„ä»»åŠ¡è¿”å›å‡ºå»
        return handler(item, res, that.getUploadUrl, that.progress).then(() => {
          return index
        })
      })
      (async function loop() {
        // handler æœ€å¿«å¤„ç†å®Œçš„promises
        let p = Promise.race(promises)
        // éå†å‰©ä½™æ•°æ®
        for (let i = 0; i < fileArray.length; i++) {
          // æ›´æ–° Promise.race
          p = p.then(async (newIndex) => {
            // å°†æ­£åœ¨å¤„ç†çš„ä»»åŠ¡è¿”å›å‡ºå»
            let suffix = fileArray[i].name.split('.').pop().toLowerCase()
            let res = await getUploadId({ suffix })
            promises[newIndex] = handler(fileArray[i], res, that.getUploadUrl, that.progress).then(() => {
              return newIndex
            })
            // é‡æ–°æ‰§è¡Œpromises
            return Promise.race(promises)
          })
        }
      })() // è‡ªæ‰§è¡Œå‡½æ•°
      
      // æˆ‘æƒ³é‡ç‚¹è§£æä¸€ä¸‹loop è‡ªæ‰§è¡Œå‡½æ•°ï¼Œå› ä¸ºå…³é”®ç‚¹å°±åœ¨è¿™é‡Œï¼Œä¸Šé¢ç›´æ¥è·‘3ä¸ªpromsieï¼Œç„¶åè°å›æ¥å°±ä¼šè§¦å‘promise.race
      // loopé‡Œé¢ï¼Œå…ˆèµ‹å€¼ p = Promise.race(promises)ï¼Œç„¶åå‰©ä½™æ•°æ®å…¨éƒ¨éå†ä¸€éï¼Œthené‡Œé¢æ˜¯å¼‚æ­¥ï¼Œåªè¦é‡è§è°ç»“æŸäº†ï¼Œå…ˆæŠŠæ–°çš„è¦å¤„ç†æ•°æ®å¤„ç†å¥½ï¼Œå¹¶ä¸”è¿”å›å‡ºå»ï¼Œæ¥ç€return Promise.race(promises)ã€‚è¿™ä¹ˆç®€å•çš„promiseï¼Œä»£ç é‡è¿™ä¹ˆå°‘ï¼Œéš¾é“ä¸é¦™å—ï¼Ÿ
  },
    
    
    // å‰©ä¸‹çš„ä¸¤ä¸ªå›è°ƒæ„Ÿè§‰ä¸€æ ·ä¸å¤ªå¤§
    
    // ä¸Šä¼ è¿›åº¦
    progress(currentChunk, chunks, file) {
      console.log(currentChunk, chunks, file, 'progress')
      let flag = false
      this.viewFile.forEach((item) => {
        if (item.name === file.name) {
          item.percentage = (currentChunk / chunks).toFixed(2) * 100
          console.log(item.percentage, 'item.percentage')
          if (item.percentage != 100) {
            // æ²¡æœ‰å…¨éƒ¨ä¸Šä¼ å®Œä¸èƒ½æäº¤
            flag = true
          }
        }
      })
      this.loadingFlag = flag
    },
    getUploadUrl(res) {
      this.addDoc.items = [...this.addDoc.items, res]
      this.addDoc.items.forEach((item) => {
        item.file_path = item.name
      })
      console.log(this.addDoc.items, 'ä¸Šä¼ æˆåŠŸ')
    },
    
```



#### åˆ†ç‰‡ä¸Šä¼ 

æ€è·¯å°±æ˜¯å°†input ä¼ è¿‡æ¥çš„e.target.files è¿™ä¸ªæ•°ç»„ï¼Œé‡Œé¢çš„æ¯ä¸€é¡¹ï¼Œç”¨slice åˆ‡å‰²æˆä¸€ç‰‡ä¸€ç‰‡çš„ä¸Šä¼ ï¼Œå°±å®Œæˆäº†ï¼Œå½“ç„¶éœ€è¦åšçš„äº‹è¿˜è¦ä¸€ä¸‹æ¯”è¾ƒæ‚çš„ï¼Œä»£ç å‘ˆç°ã€‚

`spark-md5:`å½“ä»–ä»¬çš„è®¡ç®—æ–¹å¼ä¸€æ ·çš„æ—¶å€™ï¼Œæ¯ä¸€ä¸ªæ–‡ä»¶éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„md5å€¼ï¼Œè¿™å°±å¯ä»¥ç»™åå°ä¸€äº›åˆ¤æ–­ï¼Œmd5å€¼å¯¹æ¯”åå‘ç°ï¼Œè¿™ä¸ªæ–‡ä»¶æˆ‘å¾ˆä¹…ä¹‹å‰ä¸Šä¼ è¿‡äº†ï¼Œé‚£æˆ‘å¯ä»¥è¿”å›å»å‰ç«¯å‘Šè¯‰ä»–ï¼Œæœ¬æ–‡ä»¶å·²ä¸Šä¼ æˆåŠŸã€‚

```js
import Vue from 'vue'
// uploadPart å•ç‰‡ä¸Šä¼ æ¥å£ï¼ŒuploadCompleteä¸Šä¼ å®Œæˆæ¥å£ï¼Œå…¶å®è¿˜æœ‰ä¸€ä¸ªåˆå§‹åŒ–çš„æ¥å£ï¼Œåé¢ä»£ç ä¼šæœ‰çš„
import { uploadPart, uploadComplete } from '@/api/base-api' 
import SparkMD5 from 'spark-md5'

export default function () {
  // å°†ä¸Šä¼ æ–‡ä»¶çš„æ–¹æ³•æŒ‚è½½åˆ°vueçš„åŸå‹é“¾ä¸Šé¢
  Vue.prototype.uploadFile = uploadFile
  let spark = new SparkMD5.ArrayBuffer() // å®ä¾‹åŒ–md5
  async function uploadFile(file, params, callback, callbackProgress) {
    // fileï¼šæ–‡ä»¶æ•°æ®
    // paramsï¼šä¸Šä¼ çš„å‚æ•°ï¼Œå°±æ˜¯ä¸Šé¢è¯´çš„åˆå§‹åŒ–çš„æ—¶å€™ä¼ è¿‡æ¥çš„ï¼Œé‚£ä¹ˆä½ å¯ä»¥æŠŠä»–ä¼˜åŒ–ä¸€ä¸‹æ”¾åˆ°é‡Œé¢æ¥ä¹Ÿæ˜¯å¯ä»¥çš„
    // callbackï¼š ä¸Šä¼ æˆåŠŸåçš„å›è°ƒ
    // callbackProgressï¼šä¸Šä¼ è¿›åº¦å›è°ƒ è¿™ä¸¤ä¸ªå›è°ƒå¯ä»¥åšä¸€èµ·çš„ï¼Œä½†æ˜¯è€ƒè™‘çš„æ˜¯ä¸åŒäº‹æƒ…å°½é‡åˆ†å¼€
    let blobSlice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice // åˆ‡ç‰‡æ–¹æ³•
    let chunkSize = 1024 * 1024 * 6 // 6Mæ¯ä¸€å—åˆ†ç‰‡ï¼Œ
    let currentChunk = 0 // å½“å‰ä¸Šä¼ åˆ†ç‰‡æ˜¯ç¬¬0å—
    let fileReader = new FileReader() // å®ä¾‹åŒ–fileReader
    return new Promise((resolve, reject) => {
      let chunks = Math.ceil(file.size / chunkSize) // å°†ä¼šåˆ‡å¤šå°‘å—
      // è§¦å‘æ–‡ä»¶ç¬¬ä¸€å—ä¸Šä¼ 
      loadNext()
      // æ–‡ä»¶åˆ‡å‰²åçš„å›è°ƒï¼Œthis.resultä¸ºåˆ‡å‰²çš„æ–‡ä»¶å—
      fileReader.onload = async function (e) {
        // md5
        spark.append(e.target.result)
        // ç”¨FormDataä¼ è¾“æ–‡ä»¶å¯¹è±¡
        let fd = new FormData()
        fd.append('uploadId', params.uploadId)
        fd.append('name', params.name)
        fd.append('currentPart', currentChunk)
        // è®¾ç½®ä¸Šä¼ çš„å½“å‰çš„æ–‡ä»¶å—
        fd.append('file', new Blob([e.target.result]))
        let res = await uploadPart(fd)
        // åˆ¤æ–­å½“å‰åˆ‡ç‰‡æ˜¯å¦å°äºæ€»åˆ‡ç‰‡æ•°é‡
        if (currentChunk < chunks) {
          callbackProgress && callbackProgress(currentChunk, chunks, file)
          loadNext() // ç»§ç»­åˆ‡å‰²ä¸‹ä¸€å—æ–‡ä»¶
        } else {
          params.file_name = file.name 
          params.use_scene = params.use_scene  // ä½¿ç”¨åœºæ™¯ï¼Œè¿™æ˜¯æˆ‘ä»¬ä¸Šä¼ çš„æ—¶å€™è®°å½•çš„ï¼Œä»¥åå¥½æŸ¥è¯¢æ•°æ®
          params.file_md5 = spark.end() // å‰ç«¯è®¡ç®—å¥½md5 ä¸¢ç»™åç«¯ï¼Œæˆ‘å‰é¢è¯´è¿‡md5å¯ä»¥ç»™åå°åšæ˜¯å¦ä¸Šä¼ è¿‡ï¼Œ
          // ä½†æ˜¯æˆ‘è¿™é‡Œåœ¨æœ€åé¢æ‰åšäº†md5.end(), å› ä¸ºæˆ‘ä»¬åå°æ²¡æœ‰åšè¿™æ ·çš„æ ¡éªŒï¼Œæä¸ªå»ºè®®å°±æ˜¯ï¼Œåœ¨å¤šå‡ºä¸€ä¸ªæ¥å£ï¼Œä¼ md5æ¥åˆ¤æ–­å½“å‰æ–‡ä»¶æ˜¯å¦ä¸Šä¼ è¿‡ï¼Œæœ‰ç»“æŸï¼Œè¿”å›urlï¼Œæ²¡æœ‰èµ°ä¸Šä¼ é€»è¾‘
          let res = await uploadComplete(params)
          callbackProgress && callbackProgress(currentChunk, chunks, file)
          // æ–‡ä»¶ä¸Šä¼ æˆåŠŸ
          callback && callback(params)
          // åˆå§‹åŒ–æ•°æ®
          currentChunk = 0
          // è¿”å›å‡ºå»
          resolve()
        }
      }

      //å¤„ç†å•ç‰‡æ–‡ä»¶çš„ä¸Šä¼ 
      async function loadNext() {
        currentChunk++ // æ›´æ–°å½“å‰ä¸Šä¼ çš„æ˜¯ç¬¬å‡ å—
        // è®¡ç®—åˆ‡å‰²æ–‡ä»¶çš„å¼€å§‹ç´¢å¼•å’Œç»“æŸç´¢å¼•
        let start = (currentChunk - 1) * chunkSize
        let end = Math.min(start + chunkSize, file.size)
				// fileReader.readAsArrayBuffer è¿™ä¸ªä¸œè¥¿ä¹Ÿæ˜¯æœ‰ç‚¹è®²ç©¶çš„ï¼Œæœ‰å…´è¶£è‡ªå·±å»ç ”ç©¶fileReader
        // åˆ‡å‰²æ–‡ä»¶å¹¶è§¦å‘fileReader.onload
        fileReader.readAsArrayBuffer(blobSlice.call(file, start, end))
      }
    })
  }
}

// åˆ†ç‰‡çš„é€»è¾‘å¤§æ¦‚è¿™äº›ï¼Œå…¶å®è¿˜æœ‰å¾ˆå¤šåœ°æ–¹éœ€è¦å®Œå–„çš„ï¼Œè‹¦äºå¤ªå¿™äº†ï¼Œè¿™é‡Œæ•è·é”™è¯¯ä¹Ÿæ˜¯æ²¡æœ‰åšçš„ï¼Œå¸Œæœ›ä½ å¯ä»¥åŠ ä¸Š ğŸ˜…ğŸ˜…
```

æ•ˆæœå›¾

<img src="/Users/atoe/Desktop/blog/-/static/images/åˆ†ç‰‡ä¸Šä¼ ï¼Œä»¥åŠé™åˆ¶ä¸Šä¼ æ•°é‡.png" alt="ç»“æœå›¾" style="zoom:30%;" />

